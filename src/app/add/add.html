<div class="add-container">

  <div class="add-form">
    <h2>{{ headerText }}</h2>

    <form [formGroup]="addItemForm" (ngSubmit)="onSubmit()">

      <section class="form-section tag-section">
        <div class="tag-input-group">
          <input type="text" placeholder="Enter tag name (e.g., angular, rxjs)" [(ngModel)]="tagInput"
            [ngModelOptions]="{standalone: true}" (keydown.enter)="$event.preventDefault(); addTag()"
            (input)="filterSuggestions()" list="tag-suggestions" autocapitalize="off" />
          <button type="button" (click)="addTag()">Add Tag</button>
        </div>

        <datalist id="tag-suggestions">
          @for (tag of suggestionTags; track tag.id) {
          <option [value]="tag.name"></option>
          }
        </datalist>

        <div class="tag-pills">
          @for (tag of tags; track tag) {
          <span class="tag-pill">
            {{ tag }}
            <button type="button" class="remove-tag" (click)="removeTag(tag)"
              title="Remove Tag: {{ tag }}">&times;</button>
          </span>
          }
        </div>
      </section>

      <section class="form-section item-section">

        <div class="form-group">
          <input id="dateOfOrigin" type="date" formControlName="dateOfOrigin" required>
        </div>

        <div class="form-group">
          <input id="url" type="url" formControlName="url" placeholder="URL (Required if no files are uploaded)">
        </div>

        <div class="form-group file-upload-group">
          <label for="files">File Upload</label>
          <input id="files" type="file" (change)="onFileSelected($event)" multiple>
        </div>

        @if (selectedFiles.length > 0) {
        <div class="file-list-container">
          <h3>Uploaded Files ({{ selectedFiles.length }})</h3>
          <ul class="file-list">
            @for (file of selectedFiles; track $index) {
            <li class="file-item">
              <span class="file-order">{{ $index + 1 }}.</span>
              <span class="file-name">{{ file.name }}</span>

              <div class="file-actions">
                <button type="button" class="move-up" (click)="moveFileUp($index)" [disabled]="$index === 0"
                  title="Move Up">
                  &uarr;
                </button>

                <button type="button" class="move-down" (click)="moveFileDown($index)"
                  [disabled]="$index === selectedFiles.length - 1" title="Move Down">
                  &darr;
                </button>

                <button type="button" class="remove-file" (click)="removeFile($index)" title="Remove File">
                  &times;
                </button>
              </div>
            </li>
            }
          </ul>
        </div>
        }

        <input type="hidden" formControlName="name">
      </section>

      <section class="button-section">
        <button type="button" class="cancel-button" (click)="cancel()">
          Cancel
        </button>
        <button type="submit" class="submit-button" [disabled]="addItemForm.invalid || loading">
          @if (loading) {
          <span>Submitting...</span>
          } @else {
          <span>{{ submitButtonText }}</span>
          }
        </button>
      </section>
    </form>
  </div>

  <div class="add-preview">
    @if (isEditing) {
    <h2>Preview</h2>
    <div class="carousel-container">
      @if (editedItem.safe_media_urls && editedItem.safe_media_urls.length > 0) {
      <div class="carousel-wrapper" [style.transform]="'translateX(' + (-(editedItem.currentIndex || 0) * 100) + '%)'">
        @for (media of editedItem.safe_media_urls; track media.id) {
        <div class="carousel-slide" [class.is-active]="$index === (editedItem.currentIndex || 0)">
          @if (media.media_type === 'video') {
          <div class="item-content-video">
            <video #mediaElement controls loop [muted]="true" autoplay>
              <source [src]="media.safe_hd_url">
            </video>
          </div>
          } @else {
          <div class="item-content-image">
            <img [src]="media.safe_hd_url" alt="Media content" loading="lazy">
          </div>
          }
        </div>
        }
      </div>

      @if (editedItem.safe_media_urls.length > 1) {
      <button class="carousel-control prev" (click)="prevSlide(editedItem)"
        [disabled]="!editedItem.currentIndex || editedItem.currentIndex === 0">
        &#10094;
      </button>
      <button class="carousel-control next" (click)="nextSlide(editedItem)"
        [disabled]="editedItem.currentIndex === editedItem.safe_media_urls.length - 1">
        &#10095;
      </button>

      <div class="carousel-dots">
        @for (m of editedItem.safe_media_urls; track $index) {
        <span class="dot" [class.active]="$index === (editedItem.currentIndex || 0)"></span>
        }
      </div>
      }

      } @else if (editedItem.safe_media_urls && editedItem.safe_media_urls.length == 1) {
      <div class="item-content-video">
        <video #mediaElement controls loop [muted]="true" autoplay>
          <source [src]="editedItem.safe_media_urls[0].safe_hd_url">
        </video>
      </div>
      }
    </div>
    }
  </div>
</div>
